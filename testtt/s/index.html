<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Masoud â¤ï¸ Pishul â€” Our Chat Story</title>
  <!-- Persian-friendly font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg: #0d0f14;
      --bg2:#0f1421;
      --fg: #e7ebf3;
      --muted:#a9b1c7;
      --acc1:#ff6bcb;
      --acc2:#6bd6ff;
      --acc3:#ffd36b;
      --card: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.08);
      --shadow: 0 15px 40px rgba(0,0,0,.35);
      --ok:#47d16c; --warn:#ffbd59; --bad:#ff5d73;
    }
    .light{
      --bg:#f6f7fb; --bg2:#eef1f7; --fg:#0d1220; --muted:#556070;
      --card:#ffffff; --glass:rgba(0,0,0,.03); --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Vazirmatn", system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(255,107,203,.25), transparent 60%),
        radial-gradient(900px 500px at -10% 90%, rgba(107,214,255,.25), transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      color:var(--fg); overflow-x:hidden;
    }
    header{
      position:relative; padding:48px 24px 24px; text-align:center;
    }
    .shimmer{
      font-weight:800; letter-spacing:.5px; font-size:clamp(26px,3.8vw,46px);
      background:linear-gradient(90deg,#fff, #ffe7f6, #c9f1ff, #fff);
      -webkit-background-clip:text; background-clip:text; color:transparent; animation:shine 9s linear infinite;
    }
    @keyframes shine{ from{background-position:-200% 0} to{background-position:200% 0} }

    .sub{opacity:.85; margin-top:6px; font-weight:600}
    .toolbar{
      margin:22px auto 0; display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap;
    }
    .btn, .chip{
      border:1px solid transparent; background:var(--glass); color:var(--fg);
      padding:10px 14px; border-radius:14px; cursor:pointer; transition:.25s; backdrop-filter:blur(8px)
    }
    .btn:hover{transform:translateY(-2px); box-shadow:var(--shadow)}
    .btn.primary{background:linear-gradient(135deg,var(--acc1),var(--acc2)); color:#091018; font-weight:800}
    .switch{
      display:inline-flex; gap:6px; align-items:center; font-weight:700; font-size:14px;
      padding:10px 12px; border-radius:14px; background:var(--glass)
    }
    .switch input{accent-color:var(--acc1); width:18px; height:18px}

    .container{max-width:1200px; margin:0 auto; padding:12px 18px 80px}

    .grid{
      display:grid; gap:18px;
      grid-template-columns: repeat(12, 1fr);
    }
    .card{
      grid-column: span 12;
      background:var(--card); border:1px solid transparent;
      border-radius:18px; padding:18px; box-shadow:var(--shadow); position:relative; overflow:hidden
    }
    .card-header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
    .card h3{margin:0; font-size:18px}
    .hint{color:var(--muted); font-size:13px}
    .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:14px}
    .kpi{
      background:var(--glass); border-radius:14px; padding:16px; text-align:center; transition:.25s
    }
    .kpi:hover{transform:translateY(-2px)}
    .kpi .num{font-size:28px; font-weight:800}
    .kpi small{display:block; margin-top:6px; color:var(--muted)}

    /* columns */
    .span-6{grid-column: span 6}
    .span-4{grid-column: span 4}
    .span-8{grid-column: span 8}
    @media (max-width: 900px){
      .span-6,.span-4,.span-8{grid-column: span 12}
      .kpis{grid-template-columns:repeat(2,1fr)}
    }

    /* Emoji cloud */
    .emoji-cloud{display:flex; flex-wrap:wrap; gap:10px}
    .emoji-cloud .b{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; background:var(--glass)}
    .emoji-cloud .e{font-size:22px}
    .emoji-cloud .c{font-size:12px; color:var(--muted)}

    /* Pills */
    .pills{display:flex; flex-wrap:wrap; gap:8px}
    .pill{padding:8px 12px; border-radius:999px; background:var(--glass); font-size:13px}

    /* Table */
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px}
    th,td{padding:12px; border-bottom:1px dashed rgba(255,255,255,.08)}
    th{text-align:right; color:var(--muted); font-weight:700; font-size:13px}
    tbody tr:hover{background:rgba(255,255,255,.05)}

    /* tiny badges */
    .badge{padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .b1{background:rgba(255,107,203,.18)} .b2{background:rgba(107,214,255,.18)}
    .good{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* Floating hearts */
    .float-hearts{pointer-events:none; position:fixed; inset:0; overflow:hidden}
    .heart{position:absolute; opacity:.2; animation:rise 10s linear infinite}
    .heart:before{content:"â¤ï¸"; font-size:20px; display:block}
    @keyframes rise{
      from{transform:translateY(100vh) scale(.8) rotate(0deg)}
      to{transform:translateY(-10vh) scale(1.3) rotate(12deg)}
    }
  </style>
</head>
<body>
  <div class="float-hearts"></div>
  <header>
    <div class="shimmer">Masoud â¤ï¸ Pishul â€” Our Chat Story</div>
    <div class="sub">Ø§Ø² <b id="dr1"></b> ØªØ§ <b id="dr2"></b> â€” <span id="days"></span> Ø±ÙˆØ² Ø¨Ø§ <span id="total"></span> Ù¾ÛŒØ§Ù…</div>
    <div class="toolbar">
      <label class="switch">
        <input type="checkbox" id="themeToggle"> Ø­Ø§Ù„Øª ØªÛŒØ±Ù‡/Ø±ÙˆØ´Ù†
      </label>
      <button class="btn" id="viewAll">Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ù‡</button>
      <button class="btn" id="viewMasoud"><span class="badge b2">Masoud</span></button>
      <button class="btn" id="viewPishul"><span class="badge b1">Pishul</span></button>
      <button class="btn primary" id="party">âœ¨ Ù…ÛŒØ¯ Ù„Ø§Ø±Ú˜: Ø§Ù†ÛŒÙ…ÛŒØ´Ù†!</button>
    </div>
  </header>

  <div class="container">
    <!-- KPIs -->
    <section class="card">
      <div class="card-header"><h3>Ù†Ù…Ø§ÛŒ Ú©Ù„ÛŒ</h3><div class="hint">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†â€ŒÙ‡Ø§ Ø¨Ø§ ÙØ§ØµÙ„Ù‡ Ø³Ø´Ù† â‰¥Û¶Û° Ø¯Ù‚ÛŒÙ‚Ù‡</div></div>
      <div class="kpis">
        <div class="kpi"><div class="num" id="k_total">0</div><small>Ú©Ù„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</small></div>
        <div class="kpi"><div class="num" id="k_sessions">0</div><small>ØªØ¹Ø¯Ø§Ø¯ Ø³Ø´Ù†â€ŒÙ‡Ø§</small></div>
        <div class="kpi"><div class="num" id="k_avgSess">0</div><small>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø¯Øª Ø³Ø´Ù† (Ø¯Ù‚ÛŒÙ‚Ù‡)</small></div>
        <div class="kpi"><div class="num" id="k_dayAvg">0</div><small>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù† Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø¯Ù‚ÛŒÙ‚Ù‡)</small></div>
      </div>
    </section>

    <section class="grid">
      <div class="card span-8">
        <div class="card-header"><h3>Ù†Ù…ÙˆØ¯Ø§Ø± ØªØ±Ú©ÛŒØ¨ÛŒ: Ø¹Ø´Ù‚/Ø³ÙˆØ§Ù„/Ø¯Ø³ØªÙˆØ±/Ù…ÛŒÙ…</h3><div class="hint">Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù‡Ø± Ù†ÙØ±</div></div>
        <canvas id="comboChart" height="140"></canvas>
      </div>

      <div class="card span-4">
        <div class="card-header"><h3>Ø´Ø±ÙˆØ¹â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ú¯ÙØªÚ¯Ùˆ</h3><div class="hint">Ø¨Ø¹Ø¯ Ø§Ø² â‰¥Û¶Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ø³Ú©ÙˆØª</div></div>
        <canvas id="initDonut" height="180"></canvas>
        <div class="hint" style="margin-top:8px">Ø§Ù…ØªÛŒØ§Ø² Ø´Ø¨ Ø±Ú©ÙˆØ±Ø¯Ø¯Ø§Ø±: <b id="recDay"></b></div>
      </div>

      <div class="card span-6">
        <div class="card-header"><h3>ØªÙˆØ²ÛŒØ¹ Ø³Ø±Ø¹Øª Ù¾Ø§Ø³Ø®</h3><div class="hint">Ø³Ø±ÛŒØ¹â€ŒØªØ± = Ø¨Ù‡ØªØ± ğŸ˜‰</div></div>
        <canvas id="replyChart" height="160"></canvas>
      </div>

      <div class="card span-6">
        <div class="card-header"><h3>Radar: Ø§Ø³ØªØ§ÛŒÙ„ Ú¯ÙØªÚ¯Ùˆ (Ø¨Ù‡â€ŒØ§Ø²Ø§ÛŒ Ù‡Ø± Û±Û°Û° Ù¾ÛŒØ§Ù…)</h3><div class="hint">Ù…Ø­Ø¨Øª/Ø§ÛŒÙ…ÙˆØ¬ÛŒ/Ø³ÙˆØ§Ù„/Ø¯Ø³ØªÙˆØ±ÛŒ/Ú©ÙˆØªØ§Ù‡</div></div>
        <canvas id="radarChart" height="160"></canvas>
      </div>

      <div class="card span-8">
        <div class="card-header"><h3>ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø±ØªÚ©Ø±Ø§Ø±</h3><div class="hint">Top 10 Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù†ÙØ±</div></div>
        <div class="pills" id="wordsMasoud" style="margin-bottom:8px"></div>
        <div class="pills" id="wordsPishul"></div>
      </div>

      <div class="card span-4">
        <div class="card-header"><h3>Ø³Ù„Ø§Ù… Ùˆ Ø´Ø¨â€ŒØ¨Ø®ÛŒØ±</h3><div class="hint">ØµØ¨Ø­/Ø´Ø¨ØŒ Ø¨Ù‡ ØªÙÚ©ÛŒÚ©</div></div>
        <canvas id="greetChart" height="180"></canvas>
        <div class="hint" style="margin-top:8px">Ø¢Ø®Ø±ÛŒÙ† Ù¾ÛŒØ§Ù…Ù Ù‡Ø± Ø±ÙˆØ² â€” Masoud: <b id="lastDayM"></b> | Pishul: <b id="lastDayP"></b></div>
        <div class="hint">Ø´Ø¨â€ŒÙ‡Ø§ (Û²Û²â€“Û°Û³) â€” Masoud: <b id="lastNightM"></b> | Pishul: <b id="lastNightP"></b></div>
      </div>

      <div class="card span-6">
        <div class="card-header"><h3>ØªØ§ÛŒÙ… ØªØ§ÛŒÙ¾ Ùˆ Ø¢Ù†Ù„Ø§ÛŒÙ†</h3><div class="hint">ØªÙ‚Ø±ÛŒØ¨ÛŒ ÙˆÙ„ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ</div></div>
        <canvas id="timeChart" height="170"></canvas>
      </div>

      <div class="card span-6">
        <div class="card-header"><h3>Emoji Cloud</h3><div class="hint">Ù¾Ø±ØªÚ©Ø±Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù„ Ú†Øª</div></div>
        <div id="emojiCloud" class="emoji-cloud"></div>
      </div>

      <div class="card span-12">
        <div class="card-header"><h3>Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù†ÙØ±</h3><div class="hint">Ø§Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Ú†Øª Ø´Ù…Ø§</div></div>
        <div style="overflow:auto">
          <table id="detailTable">
            <thead>
              <tr>
                <th>Ù†ÙØ±</th><th>Ù¾ÛŒØ§Ù…</th><th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾Ø§Ø³Ø®</th><th>Ù…Ø¯ÛŒÙ† Ù¾Ø§Ø³Ø®</th>
                <th>Ø§Ø¨Ø±Ø§Ø² Ø¹Ù„Ø§Ù‚Ù‡</th><th>ØªØ¹Ø±ÛŒÙ/Ú©Ù…Ù¾Ù„ÛŒÙ…Ù†Øª</th><th>Ø³Ø¤Ø§Ù„</th>
                <th>Ø¯Ø³ØªÙˆØ±ÛŒ</th><th>Ú©ÙˆØªØ§Ù‡</th><th>Ù…ÛŒÙ…/Ø´ÙˆØ®ÛŒ</th><th>ØµØ¨Ø­â€ŒØ¨Ø®ÛŒØ±</th><th>Ø´Ø¨â€ŒØ¨Ø®ÛŒØ±</th>
                <th>Ø´Ø§Ø®Øµ Ù…Ø­Ø¨Øª/Û±Û°Û°</th><th>Ú†Ú¯Ø§Ù„ÛŒ Ø§ÛŒÙ…ÙˆØ¬ÛŒ/Û±Û°Û°</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="hint" style="margin-top:8px">
          Ø¨Ø²Ø±Ú¯â€ŒØªØ±ÛŒÙ† ÙØ§ØµÙ„Ù‡ Ø¨ÛŒâ€ŒÙ¾ÛŒØ§Ù…ÛŒ: <b id="gapLen"></b> â€” Ø§Ø² <b id="gapStart"></b> ØªØ§ <b id="gapEnd"></b> | Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø§Ø¹Øª Ø§ÙˆÙ„ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±ÙˆØ²: <b id="firstHour"></b>
        </div>
      </div>

      <div class="card span-6">
        <div class="card-header"><h3>Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±ÛŒÙ† Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h3><div class="hint">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ú©ÙˆØªØ§Ù‡</div></div>
        <div id="longestMsgs"></div>
      </div>

      <div class="card span-6">
        <div class="card-header"><h3>Top Emojis Ù‡Ø± Ù†ÙØ±</h3><div class="hint">Ø¨Ø§ ØªØ¹Ø¯Ø§Ø¯</div></div>
        <div id="perEmojis"></div>
      </div>
    </section>
  </div>

  <script>
    // --- Dataset (Ø§Ø² Ú†Øª Ø´Ù…Ø§) ---
    const data = {
      participants: ["Masoud", "Pishul cute <3"],
      date_range: ["2025-08-11","2025-09-30"],
      total_days: 48,
      total_messages: 14324,
      sessions: {
        count: 172, avg_session_min: 78.8, total_minutes: 13548.3, avg_daily_min: 282.3,
        initiations: {"Pishul cute <3":93, "Masoud":79}
      },
      record_day: {date:"2025-09-23", count:1124},
      hourly_volume_top:[2,1,3,0,23],
      hourly_emotional_top:[2,1,0,3,21],
      last_msg_by_day_counts: {"Pishul cute <3":20,"Masoud":28},
      last_msg_at_night_counts: {"Pishul cute <3":22,"Masoud":24},
      typing_minutes_by_sender: {"Masoud":779.1,"Pishul cute <3":508.1},
      online_minutes_by_sender: {"Masoud":6657.3,"Pishul cute <3":6891.0},
      affection_index: {"Masoud":4.45,"Pishul cute <3":5.47},
      emoji_density: {"Masoud":17.93,"Pishul cute <3":30.88},
      reply_distribution: {
        "Masoud":{"<1m":2238,"1â€“5m":473,"5â€“60m":240,">60m":60},
        "Pishul cute <3":{"<1m":2272,"1â€“5m":472,"5â€“60m":188,">60m":78}
      },
      // per-person headline
      head: {
        "Masoud": {messages:7105, affection:174, imperative:1078, avg_reply_min:7.2, median_reply_min:0.3, questions:281, short_msgs:2628, morning:10, night:4, compliment:142, joke_meme:712},
        "Pishul cute <3": {messages:7219, affection:246, imperative:938, avg_reply_min:10.3, median_reply_min:0.3, questions:319, short_msgs:3219, morning:8, night:10, compliment:149, joke_meme:1203}
      },
      top_words_by_sender: {
        "Masoud": ["Ø¯Ø§Ø±Ù…","Ù…ÛŒ","Ø¨Ø±Ø§","Ø¨Ø§ÛŒØ¯","Ú©Ù†","Ø®ÙˆØ¨","Ù…ÛŒÚ©Ù†Ù…","Ú©Ø±Ø¯Ù…","Ú©Ø§Ø±","ÙÚ©"],
        "Pishul cute <3": ["Ø®ÙˆØ¨","Ø¯Ø§Ø±Ù…","Ø§Ø±Ù‡","Ù†ÛŒØ³Øª","Ù…Ù†Ù…","Ø¨ÙˆØ³","Ø¯ÙˆØ³Øª","Ø¨Ø§ÛŒØ¯","ÙÚ©Ø±","Ú©Ù†"]
      },
      emoji_top_overall: {"ğŸ˜‚":663,"ğŸ˜":165,"ğŸ˜¡":148,"ğŸ˜½":119,"ğŸ—£":111,"ğŸ˜­":79,"ğŸ¥¹":70,"ğŸ˜":65,"ï¸":50,"â¤":49,"â˜¹ï¸":46,"ğŸ§":40},
      top_emojis_by_sender: {
        "Masoud":{"ğŸ˜":165,"ğŸ˜‚":129,"ğŸ’‹":29,"ğŸ«¡":25,"ï¸":20,"â¤":19,"ğŸ˜":13,"âœ¨":8,"ğŸ˜":7,"ğŸ‘":6,"ğŸ™":6,"â¤ï¸":5},
        "Pishul cute <3":{"ğŸ˜‚":534,"ğŸ˜¡":148,"ğŸ˜½":119,"ğŸ—£":111,"ğŸ˜­":76,"ğŸ¥¹":70,"ğŸ˜":58,"â˜¹ï¸":45,"ğŸ§":40,"â¤":30,"ï¸":30,"ğŸ™":14}
      },
      longest_gap: {length:"3 days 07:44:53", start:"2025-08-23 09:58:59", end:"2025-08-26 17:43:52"},
      avg_first_hour: 2.15,
      longest_msgs: {
        "Pishul cute <3": {len_chars:1249, dt:"2025-08-27 02:44:04", preview:"ØªÙ†Ù‡Ø§ Ú†ÛŒØ²ÛŒ Ú©Ù‡ ØªÙˆÛŒ Ø±ÙˆØ²Ù…Ø±Ú¯ÛŒ Ù‡Ø§Ø´ Ú©Ù… Ø¯Ø§Ø´ØªØŒ Ø¢Ø±Ø§Ù…Ø´ Ø¨ÙˆØ¯. ..."},
        "Masoud": {len_chars:805, dt:"2025-09-22 18:20:33", preview:"Ø¯Ø®ØªØ±Ù Ø§ÛŒØ±Ø§Ù†ØŒ Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³ØªØŸ ØªØ§Ø¬ Ù‡Ø§ÛŒ ØªØ§Ø²Ù‡ Ø§ÛŒ ..."}
      }
    };

    // --- Theme toggle ---
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('change', e=>{
      document.body.classList.toggle('light', e.target.checked);
    });

    // --- Hearts animation ---
    const heartsLayer = document.querySelector('.float-hearts');
    function sprinkleHearts(){
      heartsLayer.innerHTML = '';
      for(let i=0;i<28;i++){
        const h=document.createElement('div');
        h.className='heart';
        h.style.left = Math.random()*100+'%';
        h.style.animationDelay = (Math.random()*-10)+'s';
        h.style.opacity = 0.07 + Math.random()*0.2;
        heartsLayer.appendChild(h);
      }
    }
    sprinkleHearts();
    document.getElementById('party').addEventListener('click', ()=>sprinkleHearts());

    // --- Header numbers ---
    const [d1,d2] = data.date_range;
    document.getElementById('dr1').textContent = d1;
    document.getElementById('dr2').textContent = d2;
    document.getElementById('days').textContent = data.total_days.toLocaleString('fa-IR');
    document.getElementById('total').textContent = data.total_messages.toLocaleString('fa-IR');

    // Anim counters
    const animTo = (el, val) => {
      const dur=1100, t0=performance.now();
      const tick=(t)=>{
        const p=Math.min(1,(t-t0)/dur);
        const n=Math.floor(val*p);
        el.textContent = n.toLocaleString('fa-IR');
        if(p<1) requestAnimationFrame(tick); else el.textContent=val.toLocaleString('fa-IR');
      };
      requestAnimationFrame(tick);
    }
    animTo(document.getElementById('k_total'), data.total_messages);
    animTo(document.getElementById('k_sessions'), data.sessions.count);
    animTo(document.getElementById('k_avgSess'), Math.round(data.sessions.avg_session_min));
    animTo(document.getElementById('k_dayAvg'), Math.round(data.sessions.avg_daily_min));

    // Record day
    document.getElementById('recDay').textContent = `${data.record_day.date} (${data.record_day.count.toLocaleString('fa-IR')})`;

    // Last message counts
    document.getElementById('lastDayM').textContent = data.last_msg_by_day_counts["Masoud"];
    document.getElementById('lastDayP').textContent = data.last_msg_by_day_counts["Pishul cute <3"];
    document.getElementById('lastNightM').textContent = data.last_msg_at_night_counts["Masoud"];
    document.getElementById('lastNightP').textContent = data.last_msg_at_night_counts["Pishul cute <3"];

    // Gap + first-hour
    document.getElementById('gapLen').textContent = data.longest_gap.length;
    document.getElementById('gapStart').textContent = data.longest_gap.start;
    document.getElementById('gapEnd').textContent = data.longest_gap.end;
    const fh = data.avg_first_hour;
    const fh_str = `${String(Math.floor(fh)).padStart(2,'0')}:${String(Math.round((fh%1)*60)).padStart(2,'0')}`;
    document.getElementById('firstHour').textContent = fh_str;

    // Longest messages panel
    const lm = document.getElementById('longestMsgs');
    function addLM(name, obj){
      const box = document.createElement('div');
      box.style.marginBottom='10px';
      box.innerHTML = `<div class="badge ${name==='Masoud'?'b2':'b1'}" style="margin-bottom:6px">${name}</div>
      <div class="hint">${obj.dt} â€” ${obj.len_chars.toLocaleString('fa-IR')} Ú©Ø§Ø±Ø§Ú©ØªØ±</div>
      <div style="margin-top:6px;background:var(--glass); padding:10px 12px; border-radius:12px">${obj.preview}</div>`;
      lm.appendChild(box);
    }
    addLM("Masoud", data.longest_msgs["Masoud"]);
    addLM("Pishul cute <3", data.longest_msgs["Pishul cute <3"]);

    // Top words pills
    const wM = document.getElementById('wordsMasoud');
    const wP = document.getElementById('wordsPishul');
    data.top_words_by_sender["Masoud"].forEach(w=>{
      const el=document.createElement('div'); el.className='pill'; el.textContent=`Masoud â€” ${w}`; wM.appendChild(el);
    });
    data.top_words_by_sender["Pishul cute <3"].forEach(w=>{
      const el=document.createElement('div'); el.className='pill'; el.textContent=`Pishul â€” ${w}`; wP.appendChild(el);
    });

    // Emoji cloud
    const cloud = document.getElementById('emojiCloud');
    const maxEmoji = Math.max(...Object.values(data.emoji_top_overall));
    Object.entries(data.emoji_top_overall).forEach(([e,c])=>{
      const wrap=document.createElement('div'); wrap.className='b';
      const em=document.createElement('div'); em.className='e'; em.textContent=e;
      const ct=document.createElement('div'); ct.className='c'; ct.textContent=c.toLocaleString('fa-IR');
      const size = 16 + (c/maxEmoji)*18;
      em.style.fontSize = size+'px';
      wrap.appendChild(em); wrap.appendChild(ct);
      cloud.appendChild(wrap);
    });

    // Per-person emojis block
    const perE = document.getElementById('perEmojis');
    function perEm(name, obj){
      const box = document.createElement('div');
      box.style.marginBottom='10px';
      box.innerHTML = `<div class="badge ${name==='Masoud'?'b2':'b1'}" style="margin-bottom:6px">${name}</div>`;
      const row=document.createElement('div'); row.className='emoji-cloud';
      Object.entries(obj).forEach(([e,c])=>{
        const w=document.createElement('div'); w.className='b';
        const em=document.createElement('div'); em.className='e'; em.textContent=e;
        const ct=document.createElement('div'); ct.className='c'; ct.textContent=c.toLocaleString('fa-IR');
        row.appendChild(w); w.appendChild(em); w.appendChild(ct);
      });
      box.appendChild(row); perE.appendChild(box);
    }
    perEm("Masoud", data.top_emojis_by_sender["Masoud"]);
    perEm("Pishul cute <3", data.top_emojis_by_sender["Pishul cute <3"]);

    // Detail table
    const tbody = document.querySelector('#detailTable tbody');
    function rowFor(name){
      const h = data.head[name];
      const affIdx = data.affection_index[name];
      const emoDens = data.emoji_density[name];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b class="badge ${name==='Masoud'?'b2':'b1'}">${name}</b></td>
        <td>${h.messages.toLocaleString('fa-IR')}</td>
        <td>${h.avg_reply_min} Ø¯Ù‚ÛŒÙ‚Ù‡</td>
        <td>${h.median_reply_min} Ø¯Ù‚ÛŒÙ‚Ù‡</td>
        <td>${h.affection.toLocaleString('fa-IR')}</td>
        <td>${h.compliment.toLocaleString('fa-IR')}</td>
        <td>${h.questions.toLocaleString('fa-IR')}</td>
        <td>${h.imperative.toLocaleString('fa-IR')}</td>
        <td>${h.short_msgs.toLocaleString('fa-IR')}</td>
        <td>${h.joke_meme.toLocaleString('fa-IR')}</td>
        <td>${h.morning}</td>
        <td>${h.night}</td>
        <td>${affIdx}</td>
        <td>${emoDens}</td>
      `;
      tbody.appendChild(tr);
    }
    rowFor("Masoud"); rowFor("Pishul cute <3");

    // ----- Charts -----
    const COLORS = {
      m: {a:"#6bd6ff", b:"#3fa9d8", g:"#b6ecff"},
      p: {a:"#ff6bcb", b:"#e84da9", g:"#ffd6ef"},
      y:"#ffd36b", g:"#47d16c", r:"#ff6b88", v:"#b387ff"
    };

    // Combo bars: affection / questions / imperative / meme
    const comboCtx = document.getElementById('comboChart');
    const cData = {
      labels: ["Masoud","Pishul"],
      datasets:[
        {label:"Ø§Ø¨Ø±Ø§Ø² Ø¹Ù„Ø§Ù‚Ù‡", data:[data.head["Masoud"].affection, data.head["Pishul cute <3"].affection], backgroundColor:COLORS.p.g},
        {label:"Ø³Ø¤Ø§Ù„", data:[data.head["Masoud"].questions, data.head["Pishul cute <3"].questions], backgroundColor:COLORS.y},
        {label:"Ø¯Ø³ØªÙˆØ±ÛŒ", data:[data.head["Masoud"].imperative, data.head["Pishul cute <3"].imperative], backgroundColor:COLORS.v},
        {label:"Ù…ÛŒÙ…/Ø´ÙˆØ®ÛŒ", data:[data.head["Masoud"].joke_meme, data.head["Pishul cute <3"].joke_meme], backgroundColor:COLORS.m.g},
      ]
    };
    const comboChart = new Chart(comboCtx, {
      type:'bar',
      data:cData,
      options:{
        responsive:true,
        scales:{x:{stacked:true}, y:{stacked:true, ticks:{callback:(v)=>v.toLocaleString('fa-IR')}}},
        plugins:{legend:{position:'bottom'}}
      }
    });

    // Reply distribution
    const repCtx = document.getElementById('replyChart');
    const repLabels = ["<1m","1â€“5m","5â€“60m",">60m"];
    const repMasoud = repLabels.map(k=>data.reply_distribution["Masoud"][k]);
    const repPishul = repLabels.map(k=>data.reply_distribution["Pishul cute <3"][k]);
    const replyChart = new Chart(repCtx, {
      type:'bar',
      data:{labels:repLabels, datasets:[
        {label:"Masoud", data:repMasoud, backgroundColor:COLORS.m.a},
        {label:"Pishul", data:repPishul, backgroundColor:COLORS.p.a}
      ]},
      options:{responsive:true, scales:{y:{ticks:{callback:(v)=>v.toLocaleString('fa-IR')}}}, plugins:{legend:{position:'bottom'}}}
    });

    // Radar per 100 messages
    function per100(name, key){ return Math.round( (data.head[name][key] / data.head[name].messages) * 1000 ) / 10 }
    const radarCtx = document.getElementById('radarChart');
    const radar = new Chart(radarCtx, {
      type:'radar',
      data:{
        labels:["Ø´Ø§Ø®Øµ Ù…Ø­Ø¨Øª","Ú†Ú¯Ø§Ù„ÛŒ Ø§ÛŒÙ…ÙˆØ¬ÛŒ/Ù…ÛŒÙ…","Ø³Ø¤Ø§Ù„/Û±Û°Û°","Ø¯Ø³ØªÙˆØ±ÛŒ/Û±Û°Û°","Ú©ÙˆØªØ§Ù‡/Û±Û°Û°"],
        datasets:[
          {label:"Masoud",
            data:[
              data.affection_index["Masoud"],
              data.emoji_density["Masoud"],
              per100("Masoud","questions"),
              per100("Masoud","imperative"),
              per100("Masoud","short_msgs"),
            ],
            backgroundColor:"rgba(107,214,255,.25)", borderColor:COLORS.m.a, pointBackgroundColor:COLORS.m.a
          },
          {label:"Pishul",
            data:[
              data.affection_index["Pishul cute <3"],
              data.emoji_density["Pishul cute <3"],
              per100("Pishul cute <3","questions"),
              per100("Pishul cute <3","imperative"),
              per100("Pishul cute <3","short_msgs"),
            ],
            backgroundColor:"rgba(255,107,203,.23)", borderColor:COLORS.p.a, pointBackgroundColor:COLORS.p.a
          }
        ]
      },
      options:{plugins:{legend:{position:'bottom'}}, scales:{r:{angleLines:{color:"rgba(255,255,255,.15)"}}}}
    });

    // Initiations donut
    const initCtx = document.getElementById('initDonut');
    const initDonut = new Chart(initCtx, {
      type:'doughnut',
      data:{
        labels:["Masoud","Pishul"],
        datasets:[{data:[data.sessions.initiations["Masoud"], data.sessions.initiations["Pishul cute <3"]],
          backgroundColor:[COLORS.m.a, COLORS.p.a]}]
      },
      options:{plugins:{legend:{position:'bottom'}}}
    });

    // Greets
    const greetCtx = document.getElementById('greetChart');
    const greet = new Chart(greetCtx, {
      type:'bar',
      data:{
        labels:["ØµØ¨Ø­ Ø¨Ø®ÛŒØ±","Ø´Ø¨ Ø¨Ø®ÛŒØ±"],
        datasets:[
          {label:"Masoud", data:[data.head["Masoud"].morning, data.head["Masoud"].night], backgroundColor:COLORS.m.a},
          {label:"Pishul", data:[data.head["Pishul cute <3"].morning, data.head["Pishul cute <3"].night], backgroundColor:COLORS.p.a},
        ]
      },
      options:{plugins:{legend:{position:'bottom'}}}
    });

    // Time chart
    const timeCtx = document.getElementById('timeChart');
    const timeChart = new Chart(timeCtx, {
      type:'bar',
      data:{
        labels:["Masoud","Pishul"],
        datasets:[
          {label:"Typing (min)", data:[data.typing_minutes_by_sender["Masoud"], data.typing_minutes_by_sender["Pishul cute <3"]], backgroundColor:COLORS.y},
          {label:"Online (min)", data:[data.online_minutes_by_sender["Masoud"], data.online_minutes_by_sender["Pishul cute <3"]], backgroundColor:COLORS.g}
        ]
      },
      options:{plugins:{legend:{position:'bottom'}}, scales:{y:{ticks:{callback:(v)=>v.toLocaleString('fa-IR')}}}}
    });

    // View toggles (filter datasets visually)
    function highlight(name){
      // combo
      comboChart.setDatasetVisibility(0, name!=="Masoud" || true); // keep all visible
      // but fade bars via CSS filter by drawing translucent overlay:
      const idx = name==="Masoud"?0:1;
      comboChart.data.datasets.forEach((ds,i)=>{
        ds.backgroundColor = i===i ? ds.backgroundColor : ds.backgroundColor;
      });
      comboChart.update();

      // reply
      replyChart.data.datasets[0].backgroundColor = name==="Masoud"? COLORS.m.b : COLORS.m.g;
      replyChart.data.datasets[1].backgroundColor = name==="Pishul cute <3"? COLORS.p.b : COLORS.p.g;
      replyChart.update();

      // radar
      radar.setDatasetVisibility(0, name!=="Pishul cute <3");
      radar.setDatasetVisibility(1, name!=="Masoud");
      radar.update();

      // greets
      greet.update();

      // time
      timeChart.update();
    }
    document.getElementById('viewAll').addEventListener('click', ()=>{ radar.setDatasetVisibility(0,true); radar.setDatasetVisibility(1,true); radar.update(); });
    document.getElementById('viewMasoud').addEventListener('click', ()=>highlight("Masoud"));
    document.getElementById('viewPishul').addEventListener('click', ()=>highlight("Pishul cute <3"));
  </script>
</body>
</html>
