<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<title>Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes">
<style>
  :root{
    --bg:#0b1020; --card:#121832; --muted:#cfd6e6; --soft:#9aa4bf;
    --acc1:#ff5fa2; --acc2:#4ecdc4; --acc3:#7ea1ff; --acc4:#fac858;
    --grid:rgba(255,255,255,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1100px 600px at 70% -10%, rgba(126,161,255,.15), transparent 60%) , var(--bg); color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif; line-height:1.65}
  .container{max-width:1000px;margin:0 auto;padding:16px}
  .title{font-weight:800;margin:6px 0 10px}
  .subtitle{color:var(--soft);margin:-2px 0 18px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .card h3{margin:0 0 10px}
  .kpi{display:flex;gap:10px;align-items:baseline}
  .kpi .num{font-weight:900}
  .kpi .label{color:var(--soft)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .legend{display:flex;gap:10px;align-items:center;color:var(--muted)}
  .dot{width:10px;height:10px;border-radius:50%}
  .chart{width:100%;height:280px;display:block;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px dashed var(--grid)}
  .pill{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);color:#fff}
  .mono{font-family:ui-monospace,Consolas,Menlo,monospace}

  table{width:100%;border-collapse:collapse;border-radius:10px;overflow:hidden}
  th,td{padding:9px;border-bottom:1px dashed rgba(255,255,255,.08)}
  th{text-align:right;color:var(--muted);font-weight:700;font-size:12px}
  tbody tr:hover{background:rgba(255,255,255,.05)}

  /* tiny hearts */
  .float-hearts{pointer-events:none;position:fixed;inset:0;overflow:hidden}
  .heart{position:absolute;opacity:.10;animation:rise 11s linear infinite}
  .heart:before{content:"❤️";font-size:16px;display:block}
  @keyframes rise{from{transform:translateY(100vh) scale(.8)}to{transform:translateY(-10vh) scale(1.1)}}

  .debug{white-space:pre-wrap;font-family:ui-monospace,Consolas,Menlo,monospace;background:#1a2038;color:#cfe4ff;border:1px dashed rgba(255,255,255,.15);padding:10px;border-radius:10px;margin-top:8px;display:none}

  /* --- Responsive & legibility tweaks (patch) --- */
  .kpi .num{font-size:clamp(22px,6vw,32px);font-weight:900;letter-spacing:.3px}
  .title{font-size:clamp(20px,5.8vw,26px)}
  .card h3{font-size:clamp(15px,4.6vw,18px)}
  .hint, .legend{font-size:clamp(11px,2.8vw,13px)}
  .chart{min-height:220px;height:clamp(220px,42vw,320px)}
  svg text{paint-order:stroke;stroke:rgba(0,0,0,.35);stroke-width:1px}
  @media (max-width:360px){ .container{padding:8px} .card{padding:10px} }
  @media (prefers-reduced-motion: reduce){ .heart{animation:none; opacity:.12} }
</style>
</head>
<body>

<div class="float-hearts" aria-hidden="true" id="hearts"></div>

<div class="container">
  <h1 class="title">گزارش گفتگو</h1>
  <div class="subtitle">ریسپانسیو، خواناتر و بهینه‌شده</div>

  <div class="grid">

    <!-- KPIs -->
    <div class="card" style="grid-column: span 12;">
      <div class="row">
        <div class="kpi"><div class="num" id="kpi1">—</div><div class="label">کل پیام‌ها</div></div>
        <div class="kpi"><div class="num" id="kpi2">—</div><div class="label">روز فعال</div></div>
        <div class="kpi"><div class="num" id="kpi3">—</div><div class="label">میانگین / روز</div></div>
        <div class="kpi"><div class="num" id="kpi4">—</div><div class="label">میانگین طول پیام</div></div>
      </div>
    </div>

    <!-- Reply distribution -->
    <div class="card" style="grid-column: span 12;">
      <h3>توزیع سرعت پاسخ</h3>
      <div class="legend">
        <span class="dot" style="background:var(--acc2)"></span> مسعود
        <span class="dot" style="background:var(--acc1)"></span> Pishul cute &lt;3
      </div>
      <svg id="svgReply" class="chart" viewBox="0 0 360 200" role="img" aria-label="Reply distribution chart"></svg>
    </div>

    <!-- Five metrics -->
    <div class="card" style="grid-column: span 12;">
      <h3>۵ شاخص در هر ۱۰۰ پیام</h3>
      <svg id="svgFive" class="chart" viewBox="0 0 360 200" role="img" aria-label="Five per-100 metrics"></svg>
    </div>

    <!-- Typing & Online -->
    <div class="card" style="grid-column: span 12;">
      <h3>تایم تایپ و آنلاین</h3>
      <svg id="svgTime" class="chart" viewBox="0 0 360 200" role="img" aria-label="Typing and online minutes"></svg>
    </div>

    <!-- Tornado -->
    <div class="card" style="grid-column: span 12;">
      <h3>شباهت زبانی (Tornado)</h3>
      <svg id="svgTornado" class="chart" viewBox="0 0 360 220" role="img"></svg>
    </div>

    <!-- Greetings table -->
    <div class="card" style="grid-column: span 12;">
      <h3>سلام و خداحافظی‌ها</h3>
      <svg id="svgGreet" class="chart" viewBox="0 0 360 200" role="img"></svg>
    </div>

  </div>
  <pre id="dbg" class="debug"></pre>
</div>

<script>
(function(){

  // --- helper DOM/SVG
  function qs(id){ return document.getElementById(id); }
  function mk(tag, attrs){
    var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for (var k in attrs) el.setAttribute(k, attrs[k]);
    return el;
  }
  function clear(svg){ while(svg.firstChild) svg.removeChild(svg.firstChild); }
  function numFA(n){ // convert to Persian digits if needed
    return (''+n).replace(/[0-9]/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
  }

  // --- fake data (replace with real data binding in your app)
  var data = {
    head: {
      "Masoud": { messages: 820, questions: 120, imperative: 46, short_msgs: 210 },
      "Pishul cute <3": { messages: 640, questions: 92, imperative: 20, short_msgs: 185 }
    },
    affection_index: { "Masoud": 36, "Pishul cute <3": 58 },
    emoji_density: { "Masoud": 18, "Pishul cute <3": 42 },
    reply_distribution: {
      "Masoud": {"<1m":180,"1–5m":260,"5–60m":300,">60m":80},
      "Pishul cute <3": {"<1m":220,"1–5m":260,"5–60m":120,">60m":40}
    },
    typing_minutes_by_sender: { "Masoud": 430, "Pishul cute <3": 390 },
    online_minutes_by_sender: { "Masoud": 1120, "Pishul cute <3": 980 },
    tornado: [
      { label:"ضمیر اول شخص", m:62, p:48 },
      { label:"افعال ماضی", m:44, p:52 },
      { label:"افعال مضارع", m:58, p:59 },
      { label:"علامت تعجب", m:18, p:33 },
      { label:"کلمات محبت‌آمیز", m:36, p:58 }
    ],
    greetings: [
      { who:"Masoud", hello:132, bye:88 },
      { who:"Pishul cute <3", hello:158, bye:112 }
    ]
  };

  // --- fill KPIs
  (function(){
    var total = data.head["Masoud"].messages + data.head["Pishul cute <3"].messages;
    var days = 37;
    qs('kpi1').textContent = numFA(total);
    qs('kpi2').textContent = numFA(days);
    qs('kpi3').textContent = numFA(Math.round(total/days));
    var avgLen = 18;
    qs('kpi4').textContent = numFA(avgLen);
  })();

  // --- Float hearts
  (function hearts(){
    var wrap = qs('hearts');
    var w = wrap.clientWidth, h = wrap.clientHeight;
    for(var i=0;i<20;i++){
      var s = document.createElement('div'); s.className='heart';
      s.style.left = (Math.random()*w) + 'px';
      s.style.animationDelay = (Math.random()*-11) + 's';
      s.style.opacity = 0.05 + Math.random()*0.08;
      wrap.appendChild(s);
    }
  })();

  // --- grid background helper
  function grid(svg){
    var g = mk('g',{});
    for(var x=10;x<350;x+=20) g.appendChild(mk('line',{x1:x,y1:10,x2:x,y2:190,stroke:'rgba(255,255,255,.06)','stroke-width':1}));
    for(var y=10;y<190;y+=20) g.appendChild(mk('line',{x1:10,y1:y,x2:350,y2:y,stroke:'rgba(255,255,255,.06)','stroke-width':1}));
    svg.appendChild(g);
  }

  // Reply distribution (grouped bars) — patched for responsiveness + labels
  (function(){
    var svg = qs('svgReply'); clear(svg);
    svg.appendChild(mk('rect',{x:1,y:1,width:358,height:198,fill:'url(#bg)'}));
    grid(svg);

    var cats = ["<1m","1–5m","5–60m",">60m"];
    var m = cats.map(function(k){return data.reply_distribution["Masoud"][k];});
    var p = cats.map(function(k){return data.reply_distribution["Pishul cute <3"][k];});
    var max = Math.max.apply(null, m.concat(p));
    if(max < 1) max = 1;

    var innerL=30, innerR=330, base=170;
    var n = cats.length;
    var avail = innerR - innerL;
    var gap = 18;
    var w = Math.floor((avail - (n-1)*gap) / (n*2));
    if(w < 18){ w = 18; gap = Math.max(10, Math.floor((avail - n*2*w)/(n-1))); }
    var totalW = n*2*w + (n-1)*gap;
    var left = innerL + Math.max(0, Math.floor((avail - totalW)/2));

    var scale = (120/max);

    // axis
    svg.appendChild(mk('line',{x1:innerL,y1:base,x2:innerR,y2:base,stroke:'#6b7280','stroke-width':1}));

    function label(x, y, val){
      var t = mk('text',{x:x, y:Math.max(24,y), fill:'#fff','font-size':'12','text-anchor':'middle','font-weight':'700'});
      t.textContent = numFA(Math.round(val));
      svg.appendChild(t);
    }

    cats.forEach(function(lbl,i){
      var x = left + i*(w*2+gap);
      // Masoud
      var h1 = m[i]*scale;
      svg.appendChild(mk('rect',{x:x,y:base-h1,width:w,height:h1,fill:'var(--acc2)',rx:4,ry:4}));
      label(x+w/2, base-h1-6, m[i]);

      // Pishul
      var h2 = p[i]*scale;
      svg.appendChild(mk('rect',{x:x+w,y:base-h2,width:w,height:h2,fill:'var(--acc1)',rx:4,ry:4}));
      label(x+w+w/2, base-h2-6, p[i]);

      // label
      var t = mk('text',{x:x+w,y:base+16,fill:'#cfd6e6','font-size':'12','text-anchor':'middle'});
      t.textContent = lbl; svg.appendChild(t);
    });
  })();

  // Five metrics per 100 (side-by-side bars) — improved value labels
  (function(){
    var svg = qs('svgFive'); clear(svg);
    grid(svg);
    var labels = ["محبت/۱۰۰","ایموجی/۱۰۰","سؤال/۱۰۰","دستوری/۱۰۰","کوتاه/۱۰۰"];
    function per100(name,key){ return Math.round((data.head[name][key]/data.head[name].messages)*1000)/10; }
    var m = [data.affection_index["Masoud"], data.emoji_density["Masoud"], per100("Masoud","questions"), per100("Masoud","imperative"), per100("Masoud","short_msgs")];
    var p = [data.affection_index["Pishul cute <3"], data.emoji_density["Pishul cute <3"], per100("Pishul cute <3","questions"), per100("Pishul cute <3","imperative"), per100("Pishul cute <3","short_msgs")];
    var max = Math.max.apply(null, m.concat(p)); if(max<1) max=1;
    var left=80, top=20, barH=16, gap=18, width=240;
    // axis
    svg.appendChild(mk('line',{x1:left,y1:top-10,x2:left+width,y2:top-10,stroke:'rgba(255,255,255,.15)','stroke-width':1}));
    labels.forEach(function(lbl,i){
      var y = top + i*(barH+gap);
      var w1 = (m[i]/max)*width, w2=(p[i]/max)*width;
      svg.appendChild(mk('rect',{x:left,y:y,width:w1,height:barH,fill:'var(--acc2)',rx:4,ry:4}));
      svg.appendChild(mk('rect',{x:left,y:y+barH+4,width:w2,height:barH,fill:'var(--acc1)',rx:4,ry:4}));
      var t = mk('text',{x:10,y:y+barH,'font-size':'12',fill:'#cfd6e6'}); t.textContent=lbl; svg.appendChild(t);
      var v1x = Math.min(left+width-8, left+w1+6);
      var v2x = Math.min(left+width-8, left+w2+6);
      var v1 = mk('text',{x:v1x,y:y+barH-2,'font-size':'12',fill:'#cfefff'}); v1.textContent=m[i]; svg.appendChild(v1);
      var v2 = mk('text',{x:v2x,y:y+barH+barH+2,'font-size':'12',fill:'#ffe3f3'}); v2.textContent=p[i]; svg.appendChild(v2);
    });
  })();

  // Time chart (typing & online) — add numeric labels
  (function(){
    var svg = qs('svgTime'); clear(svg);
    grid(svg);
    var cats = ["تایپ (دقیقه)","آنلاین (دقیقه)"];
    var m = [data.typing_minutes_by_sender["Masoud"], data.online_minutes_by_sender["Masoud"]];
    var p = [data.typing_minutes_by_sender["Pishul cute <3"], data.online_minutes_by_sender["Pishul cute <3"]];
    var max = Math.max.apply(null, m.concat(p)); if(max<1) max=1;
    var left=50, base=170, w=50, gap=80, scale=(120/max);
    svg.appendChild(mk('line',{x1:30,y1:base,x2:330,y2:base,stroke:'#6b7280','stroke-width':1}));
    function label(x, y, val){
      var t = mk('text',{x:x, y:Math.max(24,y), fill:'#fff','font-size':'12','text-anchor':'middle','font-weight':'700'});
      t.textContent = numFA(Math.round(val)); svg.appendChild(t);
    }
    cats.forEach(function(lbl,i){
      var x = left + i*(w*2+gap);
      var h1 = m[i]*scale; svg.appendChild(mk('rect',{x:x,y:base-h1,width:w,height:h1,fill:'var(--acc3)',rx:4,ry:4}));
      label(x+w/2, base-h1-6, m[i]);
      var h2 = p[i]*scale; svg.appendChild(mk('rect',{x:x+w,y:base-h2,width:w,height:h2,fill:'var(--acc4)',rx:4,ry:4}));
      label(x+w+w/2, base-h2-6, p[i]);
      var t = mk('text',{x:x+w,y:base+16,fill:'#cfd6e6','font-size':'12','text-anchor':'middle'}); t.textContent = lbl; svg.appendChild(t);
    });
  })();

  // Tornado chart (mirrored bars)
  (function(){
    var svg = qs('svgTornado'); clear(svg);
    grid(svg);
    var cx = 180, top = 20, row = 30, w = 130;
    data.tornado.forEach(function(it, i){
      var y = top + i*row;
      var wM = (it.m/100)*w, wP=(it.p/100)*w;
      svg.appendChild(mk('rect',{x:cx-wM, y:y, width:wM, height:16, fill:'var(--acc2)', rx:4, ry:4}));
      svg.appendChild(mk('rect',{x:cx, y:y, width:wP, height:16, fill:'var(--acc1)', rx:4, ry:4}));
      svg.appendChild(mk('text',{x:cx, y:y-4, 'font-size':'12', fill:'#cfd6e6', 'text-anchor':'middle'})).textContent = it.label;
      svg.appendChild(mk('text',{x:cx-wM-6, y:y+13, 'font-size':'12', fill:'#cfefff', 'text-anchor':'end'})).textContent = numFA(it.m);
      svg.appendChild(mk('text',{x:cx+wP+6, y:y+13, 'font-size':'12', fill:'#ffe3f3'})).textContent = numFA(it.p);
    });
    svg.appendChild(mk('line',{x1:cx,y1:10,x2:cx,y2:210,stroke:'rgba(255,255,255,.25)','stroke-width':1,'stroke-dasharray':'3 3'}));
  })();

  // Greetings mini-bars
  (function(){
    var svg = qs('svgGreet'); clear(svg);
    grid(svg);
    var left=40, top=24, width=280, barH=16, gap=32;
    data.greetings.forEach(function(it,i){
      var y = top + i*gap;
      var h = barH;
      var w1 = (it.hello/200)*width;
      var w2 = (it.bye/200)*width;
      svg.appendChild(mk('text',{x:10,y:y+12,'font-size':'12',fill:'#cfd6e6'})).textContent = it.who;
      svg.appendChild(mk('rect',{x:left,y:y,width:w1,height:h,fill:'var(--acc3)',rx:4,ry:4}));
      svg.appendChild(mk('text',{x:left+w1+6,y:y+12,'font-size':'12',fill:'#cfefff'})).textContent = numFA(it.hello);
      y += barH+8;
      svg.appendChild(mk('rect',{x:left,y:y,width:w2,height:h,fill:'var(--acc4)',rx:4,ry:4}));
      svg.appendChild(mk('text',{x:left+w2+6,y:y+12,'font-size':'12',fill:'#ffe3f3'})).textContent = numFA(it.bye);
    });
  })();

  // --- Global error catcher to show any issue on page ---
  window.addEventListener('error', function(ev){
    var d = qs('dbg'); d.style.display='block';
    d.textContent += 'JS Error: '+ (ev.message||'') + '\n';
  });

})(); // end IIFE
</script>
</body>
</html>
